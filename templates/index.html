<!DOCTYPE html>
<html lang="jp">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Life Log （ファイル出力）</title>
  <link rel="stylesheet" href="/static/css/main.css">
</head>

<body>

  <div class="container">
    <header>
      <h1>Life Log （Web出力）</h1>
    </header>

    <main>
      <!--Add buttons to initiate auth sequence and sign out-->
      <div class="div-button">
        <a id="authorize_button" href="javascript:void(0);" class="btn btn--orange btn--radius">Authorize</a>
        <a id="signout_button" href="javascript:void(0);" class="btn btn--orange btn--radius">Sign Out</a>
        <a id="download_button" href="javascript:void(0);" class="btn btn--orange btn--radius" onclick="listUpcomingEvents();">downLoad</a>

        <pre id="content" style="white-space: pre-wrap;"></pre>
      </div>
      <script type="text/javascript">
        // Client ID and API key from the Developer Console
        var CLIENT_ID = 'XXXXX';
        var API_KEY = 'XXXXX';

        // Array of API discovery doc URLs for APIs used by the quickstart
        var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];

        // Authorization scopes required by the API; multiple scopes can be
        // included, separated by spaces.
        var SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

        var authorizeButton = document.getElementById('authorize_button');
        var signoutButton = document.getElementById('signout_button');
        var downloadButton = document.getElementById('download_button');

        /**
         *  On load, called to load the auth2 library and API client library.
         */
        function handleClientLoad() {
          gapi.load('client:auth2', initClient);
        }

        /**
         *  Initializes the API client library and sets up sign-in state
         *  listeners.
         */
        function initClient() {
          gapi.client.init({
            apiKey: API_KEY,
            clientId: CLIENT_ID,
            discoveryDocs: DISCOVERY_DOCS,
            scope: SCOPES
          }).then(function () {
            // Listen for sign-in state changes.
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

            // Handle the initial sign-in state.
            updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            authorizeButton.onclick = handleAuthClick;
            signoutButton.onclick = handleSignoutClick;
          }, function (error) {
            appendPre(JSON.stringify(error, null, 2));
          });
        }

        /**
         *  Called when the signed in status changes, to update the UI
         *  appropriately. After a sign-in, the API is called.
         */
        function updateSigninStatus(isSignedIn) {
          if (isSignedIn) {
            authorizeButton.style.display = 'none';
            signoutButton.style.display = 'block';
            downloadButton.style.display = 'block';
          } else {
            authorizeButton.style.display = 'block';
            signoutButton.style.display = 'none';
          }
        }

        /**
         *  Sign in the user upon button click.
         */
        function handleAuthClick(event) {
          gapi.auth2.getAuthInstance().signIn();
        }

        /**
         *  Sign out the user upon button click.
         */
        function handleSignoutClick(event) {
          gapi.auth2.getAuthInstance().signOut();
        }

        /**
          *  Sign in the user upon button click.
          */
        function handleDownLoadClick(event) {
          listUpcomingEvents();
        }

        /**
         * Append a pre element to the body containing the given message
         * as its text node. Used to display the results of the API call.
         *
         * @param {string} message Text to be placed in pre element.
         */
        function appendPre(message) {
          var pre = document.getElementById('content');
          var textContent = document.createTextNode(message + '\n');
          pre.appendChild(textContent);
        }

        function s2ab(s) {
          var buf = new ArrayBuffer(s.length);
          var view = new Uint8Array(buf);
          for (var i = 0; i != s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
          return buf;
        }

        /**
         * Print the summary and start datetime/date of the next ten events in
         * the authorized user's calendar. If no events are found an
         * appropriate message is printed.
         */
        function listUpcomingEvents() {
          gapi.client.calendar.events.list({
            'calendarId': 'primary',
            'timeMin': (new Date(new Date().setDate(1))).toISOString(),
            'showDeleted': false,
            'singleEvents': true,
            'maxResults': 50,
            'orderBy': 'startTime',
            'q': '仕事'
          }).then(function (response) {
            var events = response.result.items;
            console.log('-------------->');
            console.log(JSON.stringify(events));
            console.log(typeof (JSON.stringify(events)));


            appendPre('Upcoming events:');


            if (events.length > 0) {
              for (i = 0; i < events.length; i++) {
                var event = events[i];
                var start = event.start.dateTime;
                var end = event.end.dateTime;

                appendPre(event.summary + ' (' + start + ')' + ' (' + end + ')')
              }
              let xhr = new XMLHttpRequest();
              xhr.open('POST', 'http://localhost:5000/caldownload', true);
              xhr.responseType = 'blob';

              xhr.onload = function (e) {
                if (this.status == 200) {
                  var blob = this.response;
                  //aタグの生成
                  var a = document.createElement("a");
                  //レスポンスからBlobオブジェクト＆URLの生成
                  var blobUrl = window.URL.createObjectURL(new Blob([blob], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }));
                  //上で生成したaタグをアペンド
                  document.body.appendChild(a);
                  a.style = "display: none";
                  //BlobオブジェクトURLをセット
                  a.href = blobUrl;
                  //ダウンロードさせるファイル名の生成
                  a.download = "output.xlsx";
                  //クリックイベント発火
                  a.click();

                }
              };
              xhr.send(JSON.stringify(events));
            } else {
              appendPre('No upcoming events found.');
            }
          });
        }

      </script>

      <script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()">
      </script>
    </main>
    <footer>Copyright © 2021 Full of Life. All Rights Reserved.</footer>
  </div>

</body>

</html>